<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SON DU MOIS</title>
<style>
  :root{
    --bg:#000; --fg:#c8facc; --accent:#00ff66; --muted:#6be08f; --border:#0f3d22;
    --pieA:#00ff66; --pieB:#1be072; --pieC:#15c863; --pieD:#10b058; --pieE:#0b964b; --pieF:#087c3e; --pieG:#066435;
    --neon:#00ff99; --neon-2:#5affc1;

    /* Desktop: scène de référence (UI identique) */
    --design-w: 1280;  /* px */
    --design-h: 720;   /* px */
    --scale: min(100vw / var(--design-w), 100vh / var(--design-h));
  }

  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:ui-monospace,"Cascadia Code","Fira Code",Menlo,Consolas,monospace;font-size:15px;
    transition:filter .45s cubic-bezier(.22,1,.36,1);
    overflow:hidden; /* desktop: pas de scroll, tout est dans .stage */
  }
  html.neg{ filter: invert(1) hue-rotate(180deg) saturate(1.2) contrast(1.05); }

  /* ====== SCÈNE DESKTOP (fixe + scalée) ====== */
  .fit{
    width:100vw; height:100vh;
    display:grid; place-items:center; overflow:hidden;
    background:var(--bg);
  }
  .stage{
    width: calc(var(--design-w) * 1px);
    height: calc(var(--design-h) * 1px);
    transform: scale(var(--scale));
    transform-origin: center center;
    position: relative;
  }

  /* Effets globaux */
  .flash{
    position:absolute;inset:0;pointer-events:none;z-index:30;
    background:radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,.06), transparent 60%);
    opacity:0; transition:opacity .35s ease;
  }
  .flash.show{ opacity:1; }

  /* Logo central */
  .logoStage{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:0}
  .logo{
    position:relative;width:min(72vmin,86vw);height:min(72vmin,86vh);
    background:#000 url('adn.png') center/contain no-repeat;
    animation:spin 6s linear infinite;
    image-rendering:pixelated
  }
  .logo::before,.logo::after{content:"";position:absolute;inset:0;background:url('adn.png') center/contain no-repeat;mix-blend-mode:screen;pointer-events:none}
  .logo::before{opacity:.33;filter:hue-rotate(40deg) contrast(1.1);animation:glitchA 2.4s steps(6,end) infinite}
  .logo::after{opacity:.20;filter:hue-rotate(-20deg) contrast(1.15);animation:glitchB 2.1s steps(7,end) infinite reverse}
  @keyframes spin{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}
  @keyframes glitchA{0%{clip-path:inset(0 0 90% 0)}50%{clip-path:inset(60% 0 20% 0) translateX(-1px)}100%{clip-path:inset(0 0 90% 0)}}
  @keyframes glitchB{0%{clip-path:inset(10% 0 80% 0)}50%{clip-path:inset(20% 0 40% 0) translateX(1px)}100%{clip-path:inset(10% 0 80% 0)}}

  /* Panneaux desktop (absolus dans la scène) */
  .panel{
    position:absolute;top:16px;right:16px;width:360px;max-height:calc(100% - 32px);
    display:flex;flex-direction:column;gap:10px;z-index:20
  }
  .piePanel{
    position:absolute;left:16px;top:16px;width:360px;z-index:20;
    display:flex;flex-direction:column;gap:10px;max-height:calc(100% - 32px)
  }

  .box{border:2px solid var(--border);background:#05170d;padding:10px;border-radius:0}
  .titlebar{display:flex;align-items:center;justify-content:space-between;gap:10px;
    border:2px solid var(--border);background:#03140b;color:var(--accent);padding:8px 10px;
    border-radius:0;text-transform:uppercase;letter-spacing:.06em}
  .controls{display:flex;gap:8px}
  button{all:unset;cursor:pointer;border:2px solid var(--border);padding:6px 8px;color:var(--accent);
    background:#062011;border-radius:0}
  button:hover{filter:brightness(1.1)}
  .muted{color:var(--muted)}

  .list{display:flex;flex-direction:column;gap:8px;overflow:auto}
  .item{
    position:relative;
    display:grid;
    grid-template-columns:48px 1fr 104px;
    column-gap:16px; row-gap:12px;  /* + d’air entre barre et vote */
    align-items:center;
    border:2px solid var(--border); padding:10px; background:#03140b; border-radius:0;
    overflow:hidden; min-height:72px;
  }
  .rowFlash{
    position:absolute; inset:0; pointer-events:none; opacity:0;
    background:radial-gradient(140% 140% at 0% 50%, rgba(0,255,153,.15), transparent 50%);
    transition:opacity .28s ease;
  }
  .rowFlash.show{ opacity:1; }

  .cell-play{width:48px;height:48px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .play{
    display:inline-grid; place-items:center;
    width:40px; height:40px; border:2px solid var(--border);
    background:#062011; color:var(--accent);
    position:relative; overflow:hidden;
  }
  .play svg{ width:14px; height:14px; fill:currentColor; }

  /* Effet au survol uniquement (pas en lecture) */
  .play:hover{
    box-shadow:0 0 8px var(--neon), inset 0 0 8px rgba(0,255,153,.25);
    border-color:#118f5f; color:var(--neon);
    animation:neonPulse 1.2s ease-in-out infinite;
  }
  .play::after{
    content:""; position:absolute; left:-120%; top:0; bottom:0; width:120%;
    background:linear-gradient(90deg, transparent 0%, var(--neon) 45%, var(--neon-2) 55%, transparent 100%);
    opacity:0; transform:skewX(-20deg);
  }
  .play:hover::after{
    animation:btnScan 1.1s cubic-bezier(.22,1,.36,1) infinite; opacity:.35;
  }

  .track{ min-width:0; display:flex; flex-direction:column; gap:6px; }
  .track h3{
    margin:0; font-size:14px; color:var(--fg);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2;
  }

  .progress{
    position:relative;height:10px;border:2px solid var(--border);
    background:#071b10;overflow:hidden;cursor:pointer;border-radius:0
  }
  .progress:hover,
  .item.play-hover .progress{
    box-shadow:0 0 8px var(--neon), inset 0 0 8px rgba(0,255,153,.18);
    border-color:#118f5f;
    animation:neonPulse 1.2s ease-in-out infinite;
  }
  .progress::after{
    content:""; position:absolute; left:-120%; top:0; bottom:0; width:120%;
    background:linear-gradient(90deg, transparent 0%, var(--neon) 45%, var(--neon-2) 55%, transparent 100%);
    opacity:0; transform:skewX(-20deg); pointer-events:none;
  }
  .progress:hover::after,
  .item.play-hover .progress::after{
    animation:btnScan 1.4s cubic-bezier(.22,1,.36,1) infinite; opacity:.25;
  }

  .bar{position:absolute;inset:0;transform:scaleX(0);transform-origin:left;
    background:repeating-linear-gradient(90deg,#00ff66 0 8px,#14c977 8px 16px)}
  .meta{font-size:12px;color:var(--muted);line-height:1}

  /* ===== Vote button (uniquement le compteur) + animations ===== */
  .vote{
    position:relative;
    display:inline-flex; align-items:center; justify-content:center;
    width:100%; height:40px;
    border:2px solid var(--border); background:#062011; color:var(--accent);
    overflow:hidden;
  }
  .score{font-weight:700;color:#b9ffd0; font-size:15px; line-height:1;}
  .vote.voted{ border-color:#10a86b; box-shadow:0 0 8px rgba(0,255,153,.35) inset; }

  /* bump + halo */
  @keyframes voteBump{ 0%{transform:scale(1)} 40%{transform:scale(1.16)} 100%{transform:scale(1)} }
  @keyframes voteHalo{ 0%{opacity:.6; transform:scale(1)} 100%{opacity:0; transform:scale(1.8)} }
  .vote.bump .score{ animation:voteBump .35s ease-out; }
  .vote.bump::after{
    content:""; position:absolute; inset:-4px; border:2px solid var(--neon);
    opacity:0; border-radius:0; animation:voteHalo .45s ease-out forwards;
  }

  /* petit +1/-1 qui pop */
  .pop{
    position:absolute; font-weight:700; font-size:12px; pointer-events:none;
    animation:popUp .6s ease-out forwards;
  }
  @keyframes popUp{
    0%{ transform:translateY(6px); opacity:0 }
    20%{ opacity:1 }
    100%{ transform:translateY(-14px); opacity:0 }
  }

  .legend{display:flex;flex-direction:column;gap:4px;overflow:auto}
  .legend .row{display:flex;align-items:center;gap:8px}
  .legend .sw{width:12px;height:12px;border:2px solid var(--border);background:#062011}
  .legend .label{flex:1}
  .legend .val{min-width:48px;text-align:right;color:var(--muted)}

  .toast{
    position:absolute;left:16px;bottom:16px;border:2px solid var(--border);background:#03140b;
    padding:8px 10px;color:var(--accent);opacity:0;transform:translateY(8px);transition:.25s;border-radius:0;z-index:30
  }
  .toast.show{opacity:1;transform:none}

  .list{scrollbar-width:thin;scrollbar-color:#0f3d22 #03140b}
  .list::-webkit-scrollbar{width:8px}
  .list::-webkit-scrollbar-thumb{background:#0f3d22}
  .list::-webkit-scrollbar-track{background:#03140b}

  @keyframes neonPulse{ 0%,100%{ filter:brightness(1) } 50%{ filter:brightness(1.25) } }
  @keyframes btnScan{ 0%{ left:-120% } 100%{ left:120% } }

  /* ====== VERSION MOBILE (empilée, scroll) ====== */
  @media (max-width: 768px){
    /* PATCH SCROLL MOBILE */
    html, body{
      height:auto; min-height:100%; overflow:auto;
    }
    .fit{
      height:auto; min-height:100dvh; overflow:visible; display:block;
    }
    .stage{
      width:auto; height:auto; min-height:100%;
      transform:none; padding:12px;
    }

    /* Logo plus grand */
    .logoStage{
      position:relative; inset:auto; height:240px; margin-bottom:12px;
      display:grid; place-items:center;
    }
    .logo{ width:220px; height:220px; }

    .piePanel, .panel{
      position:relative; left:auto; right:auto; top:auto; width:auto;
      max-height:none; z-index:auto; margin:0 0 12px 0;
    }
    .list{ max-height:none; overflow:visible; }
    .item{
      grid-template-columns:44px 1fr 88px; min-height:64px; column-gap:16px; row-gap:10px;
    }
    .cell-play{ width:44px; height:44px; }
    .play{ width:40px; height:40px; }

    .piePanel .box:first-of-type{ display:block !important; }
    #pie{ width:100%; height:auto; max-width:480px; }

    .panel .titlebar{ position:sticky; top:0; z-index:5; }
    .toast{ position:fixed; left:12px; bottom:12px; }
  }
</style>
</head>
<body>
  <div class="fit">
    <div class="stage">
      <div class="flash" id="flash"></div>
      <div class="logoStage"><div class="logo"></div></div>

      <!-- Stats -->
      <section class="piePanel">
        <header class="titlebar"><span>~/stats</span><span id="totalVotes">votes: 0</span></header>
        <div class="box" style="display:grid;grid-template-columns:1fr;justify-items:center">
          <canvas id="pie" width="320" height="320" style="border:2px solid var(--border);background:#03140b"></canvas>
        </div>
        <div class="box legend" id="legend"></div>
      </section>

      <!-- Tracks -->
      <section class="panel">
        <header class="titlebar">
          <span>~/tracks</span>
          <div class="controls">
            <button id="sortBtn" title="tri par votes">sort --by=votes</button>
          </div>
        </header>
        <div class="box muted" id="hint">VOTE POUR TES FAV</div>
        <div class="box list" id="list" aria-live="polite"></div>
      </section>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://vmrnxfbiejzjlwstmejt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtcm54ZmJpZWp6amx3c3RtZWp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4ODI0NTksImV4cCI6MjA3NjQ1ODQ1OX0.HsMOkLDS3e3OI18mhEihpyUEka5oJAVdmtPd3ULeMiU';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = {
      sortByVotes:true,        // tri décroissant par défaut
      voterToken: localStorage.getItem('adn_voter') || (localStorage.setItem('adn_voter', crypto.randomUUID()), localStorage.getItem('adn_voter')),
      audios:new Map(),
      currentId:null,
      hasVoted:new Set(),
      counts:new Map(),
      tracks:[],
      raf:null,
      chart:{ animT:0, fromAngles:[], toAngles:[], names:[], colors:[] },
    };

    const $list=document.getElementById('list');
    const $sortBtn=document.getElementById('sortBtn');
    const $toast=document.getElementById('toast');
    const $legend=document.getElementById('legend');
    const $total=document.getElementById('totalVotes');
    const canvas=document.getElementById('pie');
    const ctx=canvas.getContext('2d');
    const $flash=document.getElementById('flash');

    const fmt=s=>{ if(!isFinite(s)) return '0:00'; const m=Math.floor(s/60), ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}`; };
    const toast=m=>{ $toast.textContent=m; $toast.classList.add('show'); setTimeout(()=> $toast.classList.remove('show'), 1200); };

    const PIE_COLS = getComputedStyle(document.documentElement);
    function colorAt(i){
      const pool = ['--pieA','--pieB','--pieC','--pieD','--pieE','--pieF','--pieG'];
      return PIE_COLS.getPropertyValue(pool[i % pool.length]).trim();
    }

    await loadData();
    renderList();
    setupRealtime();
    startTicker();

    // --- Data ---
    async function loadData(){
      const [{data:tracks,error:tErr},{data:allVotes,error:vErr},{data:mine,error:mErr}] = await Promise.all([
        supabase.from('tracks').select('id,title,url,created_at'),
        supabase.from('votes').select('track_id'),
        supabase.from('votes').select('track_id').eq('voter_token', state.voterToken),
      ]);
      if(tErr){ console.error(tErr); toast('error: tracks'); return; }
      if(vErr){ console.error(vErr); }
      if(mErr){ console.error(mErr); }

      state.tracks = tracks||[];
      state.counts = new Map();
      (allVotes||[]).forEach(v=> state.counts.set(v.track_id,(state.counts.get(v.track_id)||0)+1));
      state.hasVoted = new Set((mine||[]).map(v=> v.track_id));
      updateChartTargets();
    }

    // --- UI ---
    function renderList(){
      $list.innerHTML='';
      let data=[...state.tracks];
      // tri décroissant
      data.sort((a,b)=>(state.counts.get(b.id)||0)-(state.counts.get(a.id)||0));

      if(!data.length){
        const p=document.createElement('pre'); p.className='muted'; p.style.margin='0'; p.textContent='$ ls -la  # empty';
        $list.appendChild(p); return;
      }
      data.forEach(t=> $list.appendChild(row(t)));
    }

    function row(t){
      const voted = state.hasVoted.has(t.id);
      const votes = state.counts.get(t.id)||0;

      const el=document.createElement('div'); el.className='item'; el.dataset.id=t.id;
      el.innerHTML=`
        <div class="rowFlash"></div>
        <div class="cell-play">
          <button class="play" title="play/pause" aria-label="play/pause"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
        </div>
        <div class="track">
          <h3 title="${t.title}">${t.title}</h3>
          <div class="progress" role="slider" aria-label="position" aria-valuemin="0" aria-valuemax="100" tabindex="0"><div class="bar"></div></div>
          <div class="meta"><span class="time">0:00</span></div>
        </div>
        <button class="vote ${voted?'voted':''}" title="${voted?'retirer vote':'ajouter vote'}" aria-label="vote">
          <span class="score">${votes}</span>
        </button>
      `;

      const playBtn = el.querySelector('.play');
      const voteBtn = el.querySelector('.vote');
      const scoreEl = el.querySelector('.score');
      const rowFx  = el.querySelector('.rowFlash');

      // Audio : réutilise s'il existe déjà
      let audio = state.audios.get(t.id);
      if(!audio){
        audio = new Audio(t.url); audio.preload='metadata';
        audio.addEventListener('loadedmetadata',()=> el.querySelector('.meta .time').textContent=fmt(audio.duration));
        state.audios.set(t.id,audio);
      } else {
        // si on rerend, rafraîchit l'info durée connue
        if(isFinite(audio.duration)) el.querySelector('.meta .time').textContent=fmt(audio.duration);
      }
      // icône selon l’état
      if(!audio.paused){ icon(el,'pause'); }

      // Hover du play => scanline sur la barre de CETTE ligne (desktop)
      playBtn.addEventListener('mouseenter', ()=> el.classList.add('play-hover'));
      playBtn.addEventListener('mouseleave', ()=> el.classList.remove('play-hover'));

      // Play/pause (sans effet persistant)
      playBtn.addEventListener('click', async ()=>{
        const id=t.id; const cur=state.currentId && state.audios.get(state.currentId);
        if(state.currentId && state.currentId!==id){
          cur.pause(); cur.currentTime=0; const prev=doc(state.currentId); icon(prev,'play');
        }
        const a=state.audios.get(id);

        // flash court de la ligne
        rowFx.classList.add('show'); setTimeout(()=> rowFx.classList.remove('show'), 260);

        if(a.paused){
          await a.play().catch(()=>{});
          state.currentId=id;
          icon(el,'pause');
          setInvert(true);
          toast('play');
        } else {
          a.pause();
          icon(el,'play');
          setInvert(false);
          toast('pause');
        }
      });

      // Seek (pointer + clavier)
      const progress=el.querySelector('.progress');
      const onSeek = (ev, xRatio)=>{
        const a=state.audios.get(t.id);
        if(a && isFinite(a.duration)){
          const ratio = xRatio!=null ? xRatio : (()=>{ const rect=progress.getBoundingClientRect(); return (ev.clientX-rect.left)/rect.width; })();
          a.currentTime=Math.min(Math.max(0,ratio),1)*a.duration;
        }
      };
      let seeking=false;
      progress.addEventListener('pointerdown', (e)=>{ seeking=true; progress.setPointerCapture(e.pointerId); onSeek(e); });
      progress.addEventListener('pointermove', (e)=>{ if(seeking) onSeek(e); });
      progress.addEventListener('pointerup', (e)=>{ seeking=false; try{progress.releasePointerCapture(e.pointerId);}catch{} });
      progress.addEventListener('keydown', (e)=>{
        const a=state.audios.get(t.id); if(!a||!isFinite(a.duration)) return;
        if(e.key==='ArrowRight'||e.key==='ArrowLeft'){
          const step = e.key==='ArrowRight' ? 5 : -5;
          a.currentTime = Math.min(Math.max(0,a.currentTime+step), a.duration);
          e.preventDefault();
        }
      });

      // Vote / unvote + animations
      voteBtn.addEventListener('click', async ()=>{
        if(state.hasVoted.has(t.id)){
          const { error } = await supabase.from('votes').delete().match({ track_id:t.id, voter_token:state.voterToken });
          if(error){ console.error(error); toast('error: unvote'); return; }
          state.hasVoted.delete(t.id);
          state.counts.set(t.id, Math.max(0,(state.counts.get(t.id)||0)-1));
          scoreEl.textContent = state.counts.get(t.id);
          voteBtn.classList.remove('voted');
          pop(voteBtn, '-1', '#ff9aa2');
          bump(voteBtn);
          updateChartTargets();
          toast('vote removed');
        } else {
          const { error } = await supabase.from('votes').insert({ track_id:t.id, voter_token:state.voterToken });
          if(error){ if(error.message?.includes('duplicate')){ toast('already voted'); return; } console.error(error); toast('error: vote'); return; }
          state.hasVoted.add(t.id);
          state.counts.set(t.id, (state.counts.get(t.id)||0)+1);
          scoreEl.textContent = state.counts.get(t.id);
          voteBtn.classList.add('voted');
          pop(voteBtn, '+1', '#b9ffd0');
          bump(voteBtn);
          updateChartTargets();
          toast('vote added');
        }
        // re-tri immédiat
        renderList();
      });

      return el;
    }

    function pop(btn, text, color){
      const s=document.createElement('span');
      s.className='pop'; s.textContent=text;
      s.style.color=color; s.style.top='8px'; s.style.right='8px';
      btn.appendChild(s);
      setTimeout(()=> s.remove(), 650);
    }
    function bump(btn){
      btn.classList.remove('bump'); void btn.offsetWidth; btn.classList.add('bump');
    }

    function doc(id){ return document.getElementById('list').querySelector(`.item[data-id="${id}"]`); }
    function icon(el,mode){ if(!el) return;
      el.querySelector('.play svg').innerHTML = mode==='pause'
        ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
        : '<path d="M8 5v14l11-7z"/>'; }

    function setInvert(on){
      const htmlEl = document.documentElement;
      $flash.classList.add('show'); setTimeout(()=> $flash.classList.remove('show'), 220);
      if(on) htmlEl.classList.add('neg'); else htmlEl.classList.remove('neg');
    }

    function startTicker(){
      function tick(){
        state.raf = requestAnimationFrame(tick);
        state.audios.forEach((a,id)=>{
          const el=doc(id); if(!el||!a.duration) return;
          const p=a.currentTime/a.duration;
          el.querySelector('.bar').style.transform=`scaleX(${p})`;
          const percent = Math.round(100*p);
          const slider = el.querySelector('.progress');
          slider.setAttribute('aria-valuenow', String(percent));
          slider.setAttribute('aria-valuetext', `${percent}%`);
          el.querySelector('.meta .time').textContent = fmt(a.currentTime)+' / '+fmt(a.duration);
        });
        drawPie();
      }
      tick();
    }

    /* ===== Camembert 3D animé + labels sur parts ===== */
    function updateChartTargets(){
      const total = state.tracks.reduce((s,t)=> s + (state.counts.get(t.id)||0), 0);
      $total.textContent = 'votes: ' + total;
      const names = state.tracks.map(t=> t.title);
      const values = state.tracks.map(t=> state.counts.get(t.id)||0);
      const sum = values.reduce((a,b)=>a+b,0);
      const toAngles = [];
      let acc= -Math.PI/2;
      values.forEach((v)=>{
        const frac = sum>0 ? v/sum : 1/Math.max(values.length,1);
        const a0 = acc; const a1 = acc + frac*2*Math.PI;
        toAngles.push([a0,a1]); acc=a1;
      });
      const colors = state.tracks.map((_,i)=> colorAt(i));
      if(!state.chart.fromAngles.length || state.chart.fromAngles.length!==toAngles.length){
        state.chart.fromAngles = toAngles.map(p=>[p[0],p[1]]);
      }
      state.chart.toAngles = toAngles;
      state.chart.names = names;
      state.chart.colors = colors;
      state.chart.animT = 0;
      renderLegend(values, colors, names);
    }

    function renderLegend(values, colors, names){
      const $legend=document.getElementById('legend'); $legend.innerHTML='';
      const sum = values.reduce((a,b)=>a+b,0);
      // on affiche aussi en décroissant
      const order=[...names.keys()].sort((i,j)=>(values[j]-values[i]));
      order.forEach((i)=>{
        const v=values[i], name=names[i], col=colors[i];
        const row=document.createElement('div'); row.className='row';
        const sw=document.createElement('span'); sw.className='sw'; sw.style.background=col;
        const lb=document.createElement('span'); lb.className='label'; lb.textContent=name;
        const val=document.createElement('span'); val.className='val'; val.textContent = v + (sum? '  ('+Math.round(100*v/Math.max(sum,1))+'%)':'');
        row.appendChild(sw); row.appendChild(lb); row.appendChild(val); $legend.appendChild(row);
      });
    }

    function ease(t){ return 1 - Math.pow(1-t,3); }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function clampText(ctx, text, maxW){
      if(ctx.measureText(text).width <= maxW) return text;
      let t=text;
      while(t.length>3 && ctx.measureText(t+'…').width>maxW){ t=t.slice(0,-1); }
      return t+'…';
    }

    function drawPie(){
      const depth = 14, r = 130, cx = canvas.width/2, cy = canvas.height/2 - 6;

      if(state.chart.animT < 1){ state.chart.animT = Math.min(1, state.chart.animT + 0.08); }

      const t = ease(state.chart.animT);
      const angles = state.chart.toAngles.map((to,i)=>[
        lerp(state.chart.fromAngles[i][0], to[0], t),
        lerp(state.chart.fromAngles[i][1], to[1], t)
      ]);

      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save(); ctx.globalAlpha = 0.25; ctx.fillStyle = '#000';
      ctx.beginPath(); ctx.ellipse(cx+6, cy+depth+8, r+6, r*0.65+6, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();

      // tranche 3D
      for(let z=depth; z>0; z--){
        angles.forEach((a,i)=>{
          ctx.beginPath();
          ctx.moveTo(cx + Math.cos(a[0])*(r), cy+z + Math.sin(a[0])*(r*0.82));
          ctx.arc(cx, cy+z, r, a[0], a[1]); ctx.lineTo(cx, cy+z); ctx.closePath();
          ctx.fillStyle = shade(state.chart.colors[i], 0.6); ctx.fill();
        });
      }

      // dessus + contour
      angles.forEach((a,i)=>{
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(a[0])*(r), cy + Math.sin(a[0])*(r));
        ctx.arc(cx, cy, r, a[0], a[1]); ctx.lineTo(cx, cy); ctx.closePath();
        ctx.fillStyle = state.chart.colors[i]; ctx.fill();
        ctx.strokeStyle = '#08391f'; ctx.lineWidth = 2; ctx.stroke();
      });

      // labels sur les parts
      ctx.font = '11px ui-monospace, monospace';
      ctx.fillStyle = '#dafee0';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      state.chart.names.forEach((name,i)=>{
        const a0=angles[i][0], a1=angles[i][1];
        if(a1-a0 < 0.18) return; // pas assez de place
        const mid=(a0+a1)/2;
        const rx = cx + Math.cos(mid)*(r*0.62);
        const ry = cy + Math.sin(mid)*(r*0.62);
        // largeur approximative dispo
        const arcLen = (a1-a0) * r * 0.9;
        const text = clampText(ctx, name, Math.max(40, arcLen));
        ctx.fillText(text, rx, ry);
      });

      if(state.chart.animT===1){ state.chart.fromAngles = state.chart.toAngles.map(p=>[p[0],p[1]]); }
    }

    function shade(hex, f){
      const h = hex.replace('#','');
      const r = parseInt(h.substr(0,2),16), g = parseInt(h.substr(2,2),16), b = parseInt(h.substr(4,2),16);
      const nr = Math.max(0, Math.min(255, Math.round(r*f)));
      const ng = Math.max(0, Math.min(255, Math.round(g*f)));
      const nb = Math.max(0, Math.min(255, Math.round(b*f)));
      return '#' + nr.toString(16).padStart(2,'0') + ng.toString(16).padStart(2,'0') + nb.toString(16).padStart(2,'0');
    }

    // Realtime votes
    function setupRealtime(){
      supabase.channel('votes-stream')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, (payload)=>{
          if(payload.eventType === 'INSERT'){
            const tid = payload.new.track_id;
            state.counts.set(tid, (state.counts.get(tid)||0)+1);
          } else if(payload.eventType === 'DELETE'){
            const tid = payload.old.track_id;
            state.counts.set(tid, Math.max(0,(state.counts.get(tid)||0)-1));
          }
          // re-render pour trier + maj scores + camembert
          renderList();
          updateChartTargets();
        })
        .subscribe();
    }
  </script>
</body>
</html>
